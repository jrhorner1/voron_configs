
#####################################################################
# 	Startup Macros
#####################################################################
[delayed_gcode DISABLEFILAMENTSENSOR] ; This will disable the SFS 1 second after klipper starts
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=sfs_motion ENABLE=0

[delayed_gcode HEATSOAK_PRINTER]
initial_duration: 1
gcode:
    M140 S100                     ; set bed to 100C
    SET_IDLE_TIMEOUT TIMEOUT=3600 ; idle for 1 hour

[delayed_gcode STARTUPG32]
initial_duration: 10
gcode:
    BED_MESH_PROFILE LOAD="default"
    G32

#####################################################################
# 	Print Macros
#####################################################################

[gcode_macro G32]
gcode:
    _CG28
    _CQGL
    STATUS_BUSY
    G0 X150 Y150 Z30 F3600
    STATUS_READY

[gcode_macro M900]
gcode:
    {% set advance = params.K|default(0) %}
    SET_PRESSURE_ADVANCE ADVANCE={advance}
   
[gcode_macro _CG28]
description: Home if not already homed. 
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        STATUS_HOMING
        G28
    {% endif %}

[gcode_macro _CQGL]
description: Quad Gantry Level if not already leveled. 
gcode:
    {% if printer.quad_gantry_level.applied == False %}
        _CG28
        STATUS_LEVELING
        QUAD_GANTRY_LEVEL
        G28 Z
    {% endif %}

[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
gcode:
    G32                            ; home all axes
    STATUS_BUSY
    G1 Z20 F3000                   ; move nozzle away from bed
    #SFS_ENABLE                     ; enable smart filament sensor
    STATUS_PRINTING

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    STATUS_BUSY
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    G0  X125 Y250 F3600            ; park nozzle at rear
    BED_MESH_CLEAR
    SFS_DISABLE                    ; disble smart filament sensor
    STATUS_READY

[gcode_macro M141]
gcode:
    {% set s = params.S|default(0)|float %}
    SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={s}

#[gcode_macro CALIBRATE_Z]
#rename_existing: BASE_CALIBRATE_Z
#gcode:
#  STATUS_CALIBRATING_Z
#  BASE_CALIBRATE_Z

#####################################################################
# 	Filament Macros
#####################################################################


[gcode_macro SFS_ENABLE] ; Add this to PRINT_START
description: Enable smart filament sensor
gcode:
    M117 ENABLING the Smart Filament Sensor
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=sfs_motion ENABLE=1

[gcode_macro SFS_DISABLE] ; Add this to PRINT_END and PRINT_CANCEL
description: Disable smart filament sensor 
gcode:
    M117 DISABLING the Smart Filament Sensor
    G92 E0
    SET_FILAMENT_SENSOR SENSOR=sfs_motion ENABLE=0

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    SAVE_GCODE_STATE NAME=load_state
    G91
    G92 E0
    G1 E100 F{max_velocity} # fast load
    G1 E25 F{speed} # purge
    RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity %}
    SAVE_GCODE_STATE NAME=unload_state
    G91
    G92 E0
    G1 E25 F{speed} # purge
    G1 E-200 F{max_velocity} # fast-unload
    RESTORE_GCODE_STATE NAME=unload_state

